@model PushIndexPageViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "推流设置";
}

<div class="layui-row layui-col-space15" style="margin-bottom:50px">
    <div class="layui-col-md12">
        <div class="layui-card">
            <div class="layui-card-header layui-card-header-custum">
                简易模式（暂不支持）
                <div class="layui-form layui-form-custum">
                    <input disabled type="checkbox" name="easyModel" id="easyModel" lay-filter="easyModel" lay-skin="switch" lay-text="开启|关闭" @(Model.PushSetting.Model == ConfigModel.Normal ? "checked" : "")>
                </div>
            </div>
            <div class="layui-card-body" id="easyModelBody" style="@(Model.PushSetting.Model == ConfigModel.Normal ? "" : "display:none")">
                <div class="layui-tab layui-tab-brief" lay-filter="component-tabs-brief">
                    <ul class="layui-tab-title">
                        <li class="layui-this">基础设置</li>
                    </ul>
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <div class="layui-form" lay-filter="">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">推流分辨率</label>
                                    <div class="layui-input-inline">
                                        <select name="pushVideo" lay-verify="required" lay-search>
                                            <option value="480×320">480×320</option>
                                            <option value="640×480">640×480</option>
                                            <option value="800×600">800×600</option>
                                            <option value="1280×720">1280×720</option>
                                            <option value="1366×768">1366×768</option>
                                            <option value="1440×900">1440×900</option>
                                            <option value="1920×1080">1920×1080</option>
                                            <option value="2560×1440">2560×1440</option>
                                            <option value="3840×2160">3840×2160</option>
                                            <option value="7680×4320">7680×4320</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">自定义输出参数</label>
                                    <div class="layui-input-inline">
                                        <textarea name="other" placeholder="自定义的ffmpeg输出参数" class="layui-textarea"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="layui-tab layui-tab-brief" lay-filter="component-tabs-brief">
                    <ul class="layui-tab-title">
                        <li class="layui-this">推流视频</li>
                        <li>推流桌面</li>
                        <li>推流摄像头</li>
                        <li>推流摄像头（高级）</li>
                    </ul>
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <div class="layui-form" lay-filter="">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">推流视频</label>
                                    <div class="layui-input-inline">
                                        <select name="pushVideo" lay-verify="required" lay-search>
                                            <option value="">带搜索的选择框</option>
                                            <option value="1">layer</option>
                                            <option value="2">form</option>
                                            <option value="3">layim</option>
                                            <option value="4">element</option>
                                            <option value="5">laytpl</option>
                                            <option value="6">upload</option>
                                            <option value="7">laydate</option>
                                            <option value="8">laypage</option>
                                            <option value="9">flow</option>
                                            <option value="10">util</option>
                                            <option value="11">code</option>
                                            <option value="12">tree</option>
                                            <option value="13">layedit</option>
                                            <option value="14">nav</option>
                                            <option value="15">tab</option>
                                            <option value="16">table</option>
                                            <option value="17">select</option>
                                            <option value="18">checkbox</option>
                                            <option value="19">switch</option>
                                            <option value="20">radio</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">视频是否静音</label>
                                    <div class="layui-input-inline">
                                        <input type="checkbox" name="yyy" lay-skin="switch" lay-text="是|否">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">推流音频</label>
                                    <div class="layui-input-inline">
                                        <select name="pushVideo" lay-verify="required" lay-search>
                                            <option value="">带搜索的选择框</option>
                                            <option value="1">layer</option>
                                            <option value="2">form</option>
                                            <option value="3">layim</option>
                                            <option value="4">element</option>
                                            <option value="5">laytpl</option>
                                            <option value="6">upload</option>
                                            <option value="7">laydate</option>
                                            <option value="8">laypage</option>
                                            <option value="9">flow</option>
                                            <option value="10">util</option>
                                            <option value="11">code</option>
                                            <option value="12">tree</option>
                                            <option value="13">layedit</option>
                                            <option value="14">nav</option>
                                            <option value="15">tab</option>
                                            <option value="16">table</option>
                                            <option value="17">select</option>
                                            <option value="18">checkbox</option>
                                            <option value="19">switch</option>
                                            <option value="20">radio</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-tab-item">内容2</div>
                        <div class="layui-tab-item">内容3</div>
                        <div class="layui-tab-item">内容4</div>
                    </div>
                </div>

                <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                    解析结果：
                    <div class="layui-upload-list"></div>
                </blockquote>
            </div>
        </div>

        <div class="layui-card">
            <div class="layui-card-header layui-card-header-custum">
                高级模式
                <div class="layui-form layui-form-custum">
                    <input type="checkbox" name="advanceModel" id="advanceModel" lay-filter="advanceModel" lay-skin="switch" lay-text="开启|关闭" @(Model.PushSetting.Model == ConfigModel.Normal ? "" : "checked")>
                </div>
            </div>
            <div class="layui-card-body" id="advanceModelBody" style="@(Model.PushSetting.Model == ConfigModel.Normal ? "display:none" : "")">
                <div class="layui-collapse" lay-accordion>
                    <div class="layui-colla-item">
                        <div class="layui-colla-title">填写说明</div>
                        <div class="layui-colla-content layui-show">
                            高级模式直接填写ffmpeg推流命令。<br />
                            1. 命令必须以ffmpeg开头，以{URL}结尾。其中{URL}会自动替换为获取到的直播间推流地址；<br />
                            2. 可以使用“//”进行行注释；<br />
                            3. 素材库中的素材，可以直接粘贴到命令中，程序会自动解析。<br />
                            4. Windows下列出所有可用设备命令（在控制台执行，不要填写到下面）：ffmpeg -list_devices true -f dshow -i dummy<br />
                            示例：
                            <br />
                            <code>ffmpeg -f dshow -video_size 1280x720 -i video="HD Pro Webcam C920" -vcodec libx264 -pix_fmt yuv420p -r 30 -s 1280*720 -g 60 -b:v 5000k -an -preset:v ultrafast -tune:v zerolatency -f flv {URL}</code>
                            <br />
                            使用1280x720的分辨率，推流摄像头设备“HD Pro Webcam C920”到B站直播，编码方式为H264、帧数30。
                        </div>
                    </div>
                </div>
                <pre id="ffmpegCommand" class="layui-code" contenteditable="true" style="outline:none;height:350px;">@Html.Raw(Model.PushSetting.FFmpegCommand)</pre>
            </div>
        </div>

        <div class="layui-card">
            <div class="layui-card-header layui-card-header-custum">不间断直播设置</div>
            <div class="layui-card-body" pad15>
                <div class="layui-form" lay-filter="">
                    <div class="layui-form-item">
                        <label class="layui-form-label">是否开启不间断直播</label>
                        <div class="layui-input-inline">
                            <input type="radio" name="isAutoRetry" lay-filter="isAutoRetry" value="1" title="是" @(Model.PushSetting.IsAutoRetry ? "checked" : "")>
                            <input type="radio" name="isAutoRetry" lay-filter="isAutoRetry" value="0" title="否" @(Model.PushSetting.IsAutoRetry ? "" : "checked")>
                        </div>
                        <div class="layui-form-mid layui-word-aux">当直播推流异常终止后，是否自动重新开启推流。</div>
                    </div>
                    <div class="layui-form-item" id="retrySet" style="@(Model.PushSetting.IsAutoRetry ? "" : "display:none")">
                        <label class="layui-form-label">重试间隔时间</label>
                        <div class="layui-input-inline">
                            <input type="number" name="retryInterval" lay-affix="number" placeholder="单位：秒" value="@Model.PushSetting.RetryInterval" step="10" min="30" max="300" class="layui-input">
                        </div>
                        <div class="layui-form-mid layui-word-aux">单位：秒，不能小于30秒。</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div class="layui-btn-container footer-container">
    <div class="layui-form" lay-filter="">
        <div class="layui-input-block" style="margin-left:30px;margin-top:8px">
            <button type="button" class="layui-btn" lay-filter="submit_live_setting" lay-submit>保存设置</button>
            <button type="button" class="layui-btn layui-bg-orange" lay-filter="submit_start_live" lay-submit id="submit_start_live" style="display:none">开始直播</button>
            <button type="button" class="layui-btn layui-bg-red" lay-filter="submit_stop_live" lay-submit id="submit_stop_live" style="display:none">停止直播</button>
        </div>
    </div>
</div>



@section Styles {
    <style>
        .layui-form-label {
            width: 150px;
        }

        .layui-card-header-custum {
            display: flex;
            align-items: center;
            justify-content: start;
            height: 50px;
            font-size: 16px;
        }

        .layui-form-custum {
            display: inline-block;
            margin-left: 15px;
            margin-top: -8px;
        }

        .footer-container {
            position: fixed;
            bottom: 0px;
            left: 0px;
            right: 0px;
            width: 100%;
            height: 55px;
            background-color: rgba(90, 90, 90, 0.2);
        }
    </style>
}

@section Scripts {
    <script>
        layui.config({
            base: '@Url.Content("~/layuiadmin/")' // 静态资源所在路径
        }).use(['form', 'code', 'layer', 'jquery'], function () {
            $ = layui.jquery;
            var layer = layui.layer,
                form = layui.form;

            // 执行渲染
            var codeInst = layui.code({
                elem: '#ffmpegCommand',
                title: '命令编辑器',
                height: '300px',
                ln: false,
                header: true,
            });

            function getFFMpegCommandCode() {
                let doc = new DOMParser().parseFromString($("#ffmpegCommand").html(), 'text/html');
                let divs = doc.querySelectorAll('.layui-code-line-content');
                let code = "";
                for (var i = 0; i < divs.length; i++) {
                    if (i == divs.length - 1) {
                        code += divs[i].textContent;
                    }
                    else {
                        code += divs[i].textContent + "\r\n";
                    }
                }
                return code;
            }

            form.on('radio(isAutoRetry)', function (data) {
                if (data.value == 1) {
                    $('#retrySet').show();
                } else {
                    $('#retrySet').hide();
                }
            });

            form.on('switch(easyModel)', function (data) {
                if (this.checked) {
                    $('#easyModelBody').show();
                    $('#advanceModelBody').hide();
                    $("#advanceModel").prop("checked", false);
                } else {
                    $('#easyModelBody').hide();
                    $('#advanceModelBody').show();
                    $("#advanceModel").prop("checked", true);
                }
                form.render();
            });

            form.on('switch(advanceModel)', function (data) {
                if (this.checked) {
                    $('#easyModelBody').hide();
                    $('#advanceModelBody').show();
                    $("#easyModel").prop("checked", false);
                } else {
                    $('#easyModelBody').show();
                    $('#advanceModelBody').hide();
                    $("#easyModel").prop("checked", true);
                }
                form.render();
            });

            form.on('submit(submit_live_setting)', function (data) {
                var obj = {
                    isAutoRetry: $('input[name="isAutoRetry"]:checked').val() == 1,
                    retryInterval: $('input[name="retryInterval"]').val(),
                    model: $("#easyModel").prop("checked") ? 1 : ($("#advanceModel").prop("checked") ? 2 : 0),
                    ffmpegCommand: getFFMpegCommandCode(),
                };
                var loadIndex = layer.load(2, {
                    timeout: 300000
                });
                $.ajax({
                    type: "post",
                    url: "@Url.Action("Update", "Push")",
                    cache: false,
                    data: JSON.stringify(obj),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (data) {
                        layer.close(loadIndex);
                        if (!data) {
                            layer.msg("保存失败，返回参数为空", { icon: 5 });
                            return;
                        }
                        if (data.code < 0) {
                            layer.msg(data.message, { icon: 5 });
                            return;
                        }
                        if (data.code == 1) {
                            layer.confirm('保存成功。当前正在直播中，是否重新推流？', {
                                btn: ['是', '否'] 
                            }, function () {
                                var loadIndex = layer.load(2, {
                                    timeout: 300000
                                });
                                $.ajax({
                                    type: "post",
                                    url: "@Url.Action("ReStart", "Push")",
                                    cache: false,
                                    data: null,
                                    contentType: 'application/json',
                                    dataType: 'json',
                                    success: function (data) {
                                        layer.close(loadIndex);
                                        if (!data) {
                                            layer.msg("重新推流失败，返回参数为空", { icon: 5 });
                                            return;
                                        }
                                        if (data.code != 0) {
                                            layer.msg(data.message, { icon: 5 });
                                            return;
                                        }
                                        layer.msg('重新推流成功', { icon: 1 });
                                    },
                                    error: function (data) {
                                        layer.close(loadIndex);
                                        layer.msg("重新推流失败，未知错误", { icon: 5 });
                                        console.log(data);
                                    }
                                });
                            }, function () {
                                layer.closeAll();
                            });
                            return;
                        }
                        layer.msg('保存成功', { icon: 1 });
                    },
                    error: function (data) {
                        layer.close(loadIndex);
                        layer.msg("保存失败，未知错误", { icon: 5 });
                        console.log(data);
                    }
                });
                return false;
            });

            form.on('submit(submit_start_live)', function (data) {
                var loadIndex = layer.load(2, {
                    timeout: 300000
                });
                $.ajax({
                    type: "post",
                    url: "@Url.Action("Start", "Push")",
                    cache: false,
                    data: null,
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (data) {
                        layer.close(loadIndex);
                        if (!data) {
                            layer.msg("开启推流失败，返回参数为空", { icon: 5 });
                            return;
                        }
                        if (data.code != 0) {
                            layer.msg(data.message, { icon: 5 });
                            return;
                        }
                        layer.msg('开启推流成功', { icon: 1 });
                    },
                    error: function (data) {
                        layer.close(loadIndex);
                        layer.msg("开启推流失败，未知错误", { icon: 5 });
                        console.log(data);
                    }
                });
                return false;
            });

            form.on('submit(submit_stop_live)', function (data) {

                console.log("111");

                var loadIndex = layer.load(2, {
                    timeout: 300000
                });
                $.ajax({
                    type: "post",
                    url: "@Url.Action("Stop", "Push")",
                    cache: false,
                    data: null,
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (data) {
                        layer.close(loadIndex);
                        if (!data) {
                            layer.msg("停止推流失败，返回参数为空", { icon: 5 });
                            return;
                        }
                        if (data.code != 0) {
                            layer.msg(data.message, { icon: 5 });
                            return;
                        }
                        layer.msg('停止推流成功', { icon: 1 });
                    },
                    error: function (data) {
                        layer.close(loadIndex);
                        layer.msg("停止推流失败，未知错误", { icon: 5 });
                        console.log(data);
                    }
                });
                return false;
            });
        });

        function update() {
            $.ajax({
                type: "get",
                url: "@Url.Action("Status", "Push")",
                cache: false,
                dataType: 'json', // 返回对象
                success: function (data) {
                    if (!data) {
                        console.log("返回参数为空！");
                    }
                    if (data.data.status != 2) {
                        //显示停止按钮
                        $('#submit_start_live').hide();
                        $('#submit_stop_live').show();
                    }
                    else {
                        //显示按钮
                        $('#submit_start_live').show();
                        $('#submit_stop_live').hide();
                    }
                },
                error: function (data) {
                    console.log(data);
                }
            });
        }

        setInterval(update, 500);
    </script>
}
